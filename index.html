<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CIT Professor Network</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #f9f9f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- 顶部筛选栏 (Legend Bar) --- */
        .filter-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: #fff; border-bottom: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center;
            z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .filter-group { display: flex; gap: 10px; margin: 0 20px; align-items: center; }
        .divider { width: 1px; height: 30px; background: #eee; }
        
        /* 筛选按钮样式 */
        .filter-btn {
            padding: 6px 16px; border-radius: 20px; cursor: pointer;
            font-size: 13px; font-weight: 600; user-select: none;
            transition: all 0.2s; border: 2px solid transparent;
            opacity: 0.5; filter: grayscale(100%); /* 默认未选中状态的视觉 */
        }
        .filter-btn.active {
            opacity: 1; filter: grayscale(0%); box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* 按钮的具体颜色 (通过JS动态控制，但这里写基础类) */
        .btn-dept { color: #fff; }
        .btn-type { color: #fff; }
        
        /* --- 下拉菜单样式 --- */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }
        .dropdown-btn {
            padding: 6px 16px; border-radius: 20px; cursor: pointer;
            font-size: 13px; font-weight: 600; user-select: none;
            transition: all 0.2s; border: 2px solid transparent;
            background-color: #26c6da; color: #fff;
            display: flex; align-items: center; gap: 5px;
        }
        .dropdown-btn:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .dropdown-btn::after {
            content: '▼';
            font-size: 10px;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 320px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }
        .dropdown-menu::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .dropdown-menu::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .dropdown-action {
            font-size: 11px;
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        .dropdown-action:hover {
            color: #0056b3;
        }
        .dropdown-item {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            transition: background 0.2s;
        }
        .dropdown-item:hover {
            background: #f9f9f9;
        }
        .dropdown-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .dropdown-label {
            flex: 1;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: 500;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .dropdown-dept-divider {
            padding: 10px 15px 6px;
            font-size: 10px;
            font-weight: 700;
            color: #888;
            background: linear-gradient(to bottom, #fafafa, #f5f5f5);
            border-top: 2px solid #e8e8e8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }
        .dropdown-dept-divider:first-child {
            border-top: none;
            margin-top: 0;
        }

        /* --- 主容器 (下移以避开顶部栏) --- */
        #main { width: 100%; height: calc(100vh - 60px); margin-top: 60px; }
        
        /* --- 左下角提示面板 (移动位置) --- */
        .control-panel {
            position: absolute; bottom: 20px; left: 20px; z-index: 10;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #eee;
            max-width: 260px; pointer-events: none; /* 让鼠标能穿透点击到底下的图 */
        }
        
        /* --- 侧边抽屉 (Drawer) --- */
        .drawer {
            position: fixed; top: 60px; right: -400px; bottom: 0;
            width: 350px; background-color: #fff;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 999;
            transition: right 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column;
        }
        .drawer.open { right: 0; }
        .drawer-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .drawer-header h2 { margin: 0; font-size: 16px; color: #333; line-height: 1.4; }
        .close-btn { cursor: pointer; font-size: 24px; color: #999; }
        .drawer-body { flex: 1; padding: 20px; overflow-y: auto; }

        /* 列表项 */
        .prof-list-item { padding: 10px 0; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .prof-link { text-decoration: none; color: #333; font-weight: 500; display: block; margin-bottom: 4px;}
        .prof-link:hover { color: #007bff; }
        .tag-row { display: flex; gap: 5px; flex-wrap: wrap; }
        .mini-tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #fff; }

        
        /* // <--- 修改处 2: 优化列表样式，让详情显示更紧凑 */
        .detail-section { margin-bottom: 15px; }
        .detail-section strong { display: block; font-size: 12px; color: #999; margin-bottom: 5px; }
        .detail-list { padding-left: 18px; margin: 5px 0; font-size: 13px; color: #333; }
        .detail-list li { margin-bottom: 4px; }

        .drawer-header h2 a {
            color: #333;
            text-decoration: none;
            transition: color 0.2s;
        }
        .drawer-header h2 a:hover {
            color: #007bff; /* 悬停变为蓝色 */
            text-decoration: underline;
        }
        .link-icon { font-size: 0.8em; margin-left: 5px; color: #999; }
    </style>
</head>
<body>

    <div class="filter-bar">
        <div class="filter-group" id="deptFilters">
            <div class="filter-btn btn-dept active" data-key="CS" style="background-color: #eaecf0; color: #333;">CS</div>
            <div class="filter-btn btn-dept active" data-key="CE" style="background-color: #d1e8d6; color: #333;">CE</div>
            <div class="filter-btn btn-dept active" data-key="EE" style="background-color: #795548; color: #333">EE</div>
            <div class="filter-btn btn-dept active" data-key="MATH" style="background-color: #ffcdd2; color: #333;">MATH</div>
        </div>
        
        <div class="divider"></div>

        <div class="filter-group" id="typeFilters">
            <div class="dropdown-container">
                <div class="dropdown-btn" id="instDropdownBtn" style="background-color: #fcca00; color: #333;">
                    Institutes
                </div>
                <div class="dropdown-menu" id="instDropdownMenu">
                    <div class="dropdown-header">
                        <span class="dropdown-action" id="selectAllInstitutes">Select All</span>
                        <span class="dropdown-action" id="deselectAllInstitutes">Deselect All</span>
                    </div>
                    <div id="instDropdownItems">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-btn" id="groupDropdownBtn">
                    Research Groups
                </div>
                <div class="dropdown-menu" id="groupDropdownMenu">
                    <div class="dropdown-header">
                        <span class="dropdown-action" id="selectAllGroups">Select All</span>
                        <span class="dropdown-action" id="deselectAllGroups">Deselect All</span>
                    </div>
                    <div id="groupDropdownItems">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <h4 style="margin:0 0 5px 0;">Interactive Map</h4>
        <p style="margin:0; font-size:12px; color:#666;">
            Use the top bar to filter.<br>
            Click nodes for details.
        </p>
    </div>

    <div id="infoDrawer" class="drawer">
        <div class="drawer-header">
            <h2 id="drawerTitle">Title</h2>
            <span class="close-btn" onclick="closeDrawer()">&times;</span>
        </div>
        <div class="drawer-body">
            <div id="drawerList"></div>
        </div>
    </div>
    
    <div id="main"></div>

<script type="text/javascript">
        // --- 全局状态管理 ---
        const state = {
            activeDepts: new Set(['CS', 'CE', 'EE', 'MATH']), // 默认全选
            activeInstitutes: new Set(), // 选中的机构
            activeGroups: new Set() // 选中的研究组
        };
        
        let allGroups = []; // 存储所有研究组及其所属院系 [{name, dept}, ...]
        let allInstitutes = []; // 存储所有机构 [{name}, ...]

        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);
        var globalRawData = []; // 存储原始数据

        var orgUrls = {
            "CS": "https://www.cs.cit.tum.de/",
            "MATH": "https://www.math.cit.tum.de/",
            "CE": "https://www.ce.cit.tum.de/",
            "EE": "https://www.ee.cit.tum.de/",
            "MDSI": "https://www.mdsi.tum.de/",
            "MIRMI": "https://www.mirmi.tum.de/",
            "MCML": "https://mcml.ai/",
            "MUDS": "https://www.mu-ds.de/",
            "MIBE": "https://www.bioengineering.tum.de/",
            "Electronic, Optoelectronic & Hybrid Devices": "https://www.ee.cit.tum.de/en/ee/research/areas/electronic-optoelectronic-hybrid-devices/",
            "Electromagnetic Sensors & Measurement Systems": "https://www.ee.cit.tum.de/en/ee/research/areas/electromagnetic-sensors-measurement-systems/"
        };

        // --- 样式配置 ---
        const deptStyle = {
            "CS":   { color: "#eaecf0", labelColor: "#333", border: "#b0bec5", btnColor: "#546E7A" },
            "CE":   { color: "#d1e8d6", labelColor: "#137333", border: "#a5d6a7", btnColor: "#2e7d32" },
            "EE":   { color: "#795548", labelColor: "#fff",    border: "#5d4037", btnColor: "#5d4037" }, 
            "MATH": { color: "#ffcdd2", labelColor: "#b71c1c", border: "#ef9a9a", btnColor: "#c62828" }
        };
        const styles = {
            inst:  { color: "#fcca00", border: "#f57f17", label: "#333" }, // 机构：黄色
            group: { color: "#26c6da", border: "#0097a7", label: "#fff" }  // 研究组：青色
        };



        // --- UI 交互逻辑: 顶部按钮点击 ---
        $('.filter-btn').on('click', function() {
            $(this).toggleClass('active');
            const isActive = $(this).hasClass('active');
            
            if ($(this).hasClass('btn-dept')) {
                const key = $(this).data('key');
                isActive ? state.activeDepts.add(key) : state.activeDepts.delete(key);
                updateGraph(); // 触发重绘
            }
        });

        // --- Research Groups 下拉菜单逻辑 ---
        // 初始化研究组列表
        function initializeGroupDropdown() {
            // 提取所有独特的研究组及其所属院系
            const groupMap = new Map(); // key: groupName, value: dept
            globalRawData.forEach(prof => {
                if (prof.research_group) {
                    prof.research_group.forEach(g => {
                        // 忽略 CE 的 Neuro-Engineering
                        if (g.group_name === "Neuro-Engineering" && g.group_dept === "CE") {
                            return;
                        }
                        if (!groupMap.has(g.group_name)) {
                            groupMap.set(g.group_name, g.group_dept);
                        }
                    });
                }
            });
            
            // 转换为数组并排序：先按院系分组，再按名称排序
            const deptOrder = ['CS', 'CE', 'EE', 'MATH', 'Unknown']; // 院系顺序
            allGroups = Array.from(groupMap.entries())
                .map(([name, dept]) => ({ name, dept }))
                .sort((a, b) => {
                    // 先按院系排序
                    const deptIndexA = deptOrder.indexOf(a.dept);
                    const deptIndexB = deptOrder.indexOf(b.dept);
                    const orderA = deptIndexA === -1 ? 999 : deptIndexA;
                    const orderB = deptIndexB === -1 ? 999 : deptIndexB;
                    
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }
                    // 同一院系内按名称排序
                    return a.name.localeCompare(b.name);
                });
            
            // 默认全选
            state.activeGroups = new Set(allGroups.map(g => g.name));
            
            // 生成下拉菜单项（带院系分隔符）
            const container = $('#groupDropdownItems');
            container.empty();
            let lastDept = null;
            
            allGroups.forEach((group, index) => {
                // 如果是新的院系，添加分隔符
                if (group.dept !== lastDept) {
                    const deptName = group.dept === 'Unknown' ? 'Other' : group.dept;
                    const divider = $(`<div class="dropdown-dept-divider">${deptName} Department</div>`);
                    container.append(divider);
                    lastDept = group.dept;
                }
                
                const deptColor = deptStyle[group.dept] || { color: '#f0f0f0', labelColor: '#666' };
                const safeId = `group_${index}`; // 使用索引作为 ID，避免特殊字符
                const item = $(`
                    <div class="dropdown-item">
                        <input type="checkbox" class="dropdown-checkbox" id="${safeId}" 
                               data-group="${group.name}" checked>
                        <label class="dropdown-label" for="${safeId}" 
                               style="background-color: ${deptColor.color}; color: ${deptColor.labelColor};">
                            ${group.name}
                        </label>
                    </div>
                `);
                container.append(item);
            });
            
            // 绑定复选框事件
            $('.dropdown-checkbox').on('change', function() {
                const groupName = $(this).data('group');
                if ($(this).is(':checked')) {
                    state.activeGroups.add(groupName);
                } else {
                    state.activeGroups.delete(groupName);
                }
                updateGraph();
            });
        }
        
        // 切换下拉菜单显示
        $('#groupDropdownBtn').on('click', function(e) {
            e.stopPropagation();
            $('#groupDropdownMenu').toggleClass('show');
        });
        
        // 防止点击菜单内部时关闭
        $('#groupDropdownMenu').on('click', function(e) {
            e.stopPropagation();
        });
        
        // 点击其他地方关闭下拉菜单
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.dropdown-container').length) {
                $('#groupDropdownMenu').removeClass('show');
                $('#instDropdownMenu').removeClass('show');
            }
        });
        
        // Select All Groups
        $('#selectAllGroups').on('click', function() {
            allGroups.forEach(g => state.activeGroups.add(g.name));
            $('#groupDropdownMenu .dropdown-checkbox').prop('checked', true);
            updateGraph();
        });
        
        // Deselect All
        $('#deselectAllGroups').on('click', function() {
            state.activeGroups.clear();
            $('#groupDropdownMenu .dropdown-checkbox').prop('checked', false);
            updateGraph();
        });

        // --- Institutes 下拉菜单逻辑 ---
        // 初始化机构列表
        function initializeInstituteDropdown() {
            // 提取所有独特的机构
            const instSet = new Set();
            globalRawData.forEach(prof => {
                if (prof.inst && prof.inst.length > 0) {
                    prof.inst.forEach(inst => instSet.add(inst));
                }
            });
            
            // 转换为数组并排序
            allInstitutes = Array.from(instSet)
                .map(name => ({ name }))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            // 默认全选
            state.activeInstitutes = new Set(allInstitutes.map(i => i.name));
            
            // 生成下拉菜单项
            const container = $('#instDropdownItems');
            container.empty();
            
            allInstitutes.forEach((inst, index) => {
                const safeId = `inst_${index}`;
                const item = $(`
                    <div class="dropdown-item">
                        <input type="checkbox" class="dropdown-checkbox inst-checkbox" id="${safeId}" 
                               data-inst="${inst.name}" checked>
                        <label class="dropdown-label" for="${safeId}" 
                               style="background-color: #fcca00; color: #333;">
                            ${inst.name}
                        </label>
                    </div>
                `);
                container.append(item);
            });
            
            // 绑定复选框事件
            $(document).on('change', '.inst-checkbox', function() {
                const instName = $(this).data('inst');
                if ($(this).is(':checked')) {
                    state.activeInstitutes.add(instName);
                } else {
                    state.activeInstitutes.delete(instName);
                }
                updateGraph();
            });
        }
        
        // 切换下拉菜单显示
        $('#instDropdownBtn').on('click', function(e) {
            e.stopPropagation();
            $('#instDropdownMenu').toggleClass('show');
        });
        
        // 防止点击菜单内部时关闭
        $('#instDropdownMenu').on('click', function(e) {
            e.stopPropagation();
        });
        
        // Select All Institutes
        $('#selectAllInstitutes').on('click', function() {
            allInstitutes.forEach(i => state.activeInstitutes.add(i.name));
            $('#instDropdownMenu .inst-checkbox').prop('checked', true);
            updateGraph();
        });
        
        // Deselect All Institutes
        $('#deselectAllInstitutes').on('click', function() {
            state.activeInstitutes.clear();
            $('#instDropdownMenu .inst-checkbox').prop('checked', false);
            updateGraph();
        });

        function closeDrawer() { $('#infoDrawer').removeClass('open'); }

        myChart.showLoading();

        // --- 数据加载与处理 ---
        // 模拟数据结构，实际请替换为 $.getJSON('data.json', ...)
        // 这里为了演示方便，我把你的 JSON 片段整合进去了
        // 你使用时请用： $.getJSON('data.json', function (rawData) { ... 
        
        // 假设这里是 $.getJSON 回调内部：
        $.getJSON('data.json', function (rawData) {
            globalRawData = rawData;
            myChart.hideLoading();
            initializeInstituteDropdown(); // 初始化机构下拉菜单
            initializeGroupDropdown(); // 初始化研究组下拉菜单
            updateGraph(); // 初始化绘制
        }).fail(function(){ alert("Error loading json"); });

        // --- 核心函数：根据当前状态 State 计算节点和连线 ---
        function updateGraph() {
            let nodes = [];
            let links = [];
            let existMap = {}; 

            // 1. 辅助函数：创建节点
            function addNode(id, name, type, parentDept) {
                if (existMap[id]) return;
                
                let node = { id: id, name: name, nodeType: type, dept: parentDept, draggable: true };

                if (type === 'dept') {
                    const s = deptStyle[name];
                    node.symbolSize = 80;
                    node.itemStyle = { color: s.color, borderColor: s.border, borderWidth: 2 };
                    node.label = { show: true, position: 'inside', fontSize: 16, fontWeight: 'bold', color: s.labelColor, formatter: '{b}' };
                    node.category = 0; // 院系类别
                    node.value = 100; // 高权重，增加吸引力（不显示）
                } 
                else if (type === 'prof') {
                    const s = deptStyle[parentDept] || { color: '#999' };
                    node.symbolSize = 20;
                    node.itemStyle = { color: s.color, borderColor: s.border, borderWidth: 1 };
                    node.label = { show: true, position: 'right', formatter: function(params) { return params.data.name.split(' ').pop(); }, color: "#666" };
                    node.category = 1; // 教授类别
                    node.value = 20; // 权重（不显示）
                }
                else if (type === 'inst' || type === 'group') {
                    const s = styles[type];
                    node.symbolSize = type === 'inst' ? 45 : 35; // 机构略大，研究组略小
                    
                    // Research Group 根据所属院系设置边框颜色
                    if (type === 'group' && parentDept && deptStyle[parentDept]) {
                        const deptBorderColor = deptStyle[parentDept].border;
                        node.itemStyle = { color: s.color, borderColor: deptBorderColor, borderWidth: 2 };
                    } else {
                        node.itemStyle = { color: s.color, borderColor: s.border, borderWidth: 2 };
                    }
                    
                    node.label = { show: true, fontSize: 10, width: 80, overflow: 'break', color: "#333", formatter: '{b}' };
                    node.category = type === 'inst' ? 2 : 3; // 机构和研究组分别归类
                    node.value = 10; // 权重（不显示）
                }
                
                nodes.push(node);
                existMap[id] = true;
            }

            // 2. 遍历数据建立图谱
            globalRawData.forEach(prof => {
                // 筛选条件 A: 教授所属院系必须是被选中的
                if (!state.activeDepts.has(prof.dept)) return;

                // 筛选条件 B: 如果选中了机构，教授必须属于至少一个选中的机构
                const hasSelectedInst = state.activeInstitutes.size > 0;
                if (hasSelectedInst) {
                    const profInsts = prof.inst || [];
                    const belongsToSelectedInst = profInsts.some(inst => state.activeInstitutes.has(inst));
                    if (!belongsToSelectedInst) return; // 不属于任何选中的机构，跳过
                }

                // 筛选条件 C: 如果选中了研究组，教授必须属于至少一个选中的研究组
                const hasSelectedGroup = state.activeGroups.size > 0;
                if (hasSelectedGroup) {
                    const profGroups = prof.research_group || [];
                    const belongsToSelectedGroup = profGroups.some(g => {
                        // 忽略 CE 的 Neuro-Engineering
                        if (g.group_name === "Neuro-Engineering" && g.group_dept === "CE") {
                            return false;
                        }
                        return state.activeGroups.has(g.group_name);
                    });
                    if (!belongsToSelectedGroup) return; // 不属于任何选中的研究组，跳过
                }

                // 只有同时满足所有条件，才添加教授节点
                // 2.1 添加教授节点
                addNode(prof.name, prof.name, 'prof', prof.dept);

                // 2.2 添加院系节点 (作为中心)
                addNode(prof.dept, prof.dept, 'dept', prof.dept);
                links.push({ 
                    source: prof.name, 
                    target: prof.dept, 
                    lineStyle: { color: '#ccc', width: 2, opacity: 0.3 },
                    length: 80  // 教授到院系的距离短
                });

                // 2.3 添加机构 (只添加选中的机构)
                if (prof.inst) {
                    prof.inst.forEach(instName => {
                        // 只添加被选中的机构
                        if (!state.activeInstitutes.has(instName)) {
                            return; // 未选中，跳过
                        }
                        
                        addNode("INST_" + instName, instName, 'inst', null); // 加上前缀防止重名
                        links.push({ 
                            source: prof.name, 
                            target: "INST_" + instName, 
                            lineStyle: { color: styles.inst.color, type: 'dashed', width: 1, opacity: 0.8 },
                            length: 250  // 教授到机构的距离长，推到外圈
                        });
                    });
                }

                // 2.4 添加研究组 (只添加选中的研究组)
                if (prof.research_group) {
                    prof.research_group.forEach(group => {
                        // 忽略 group_dept 为 CE 的 Neuro-Engineering
                        if (group.group_name === "Neuro-Engineering" && group.group_dept === "CE") {
                            return; // 跳过这个组
                        }
                        
                        // 只添加被选中的研究组
                        if (!state.activeGroups.has(group.group_name)) {
                            return; // 未选中，跳过
                        }
                        
                        const groupId = "GRP_" + group.group_name;
                        addNode(groupId, group.group_name, 'group', group.group_dept);
                        links.push({ 
                            source: prof.name, 
                            target: groupId, 
                            lineStyle: { color: styles.group.color, type: 'dotted', width: 1.5, opacity: 0.8 },
                            length: 220  // 教授到研究组的距离长，推到外圈
                        });
                    });
                }
            });

            // 3. 配置 Option
            option = {
                tooltip: { 
                    trigger: 'item',
                    formatter: function(params) {
                        // 只显示节点名称，不显示 value
                        if (params.dataType === 'node') {
                            return params.data.name || '';
                        }
                        return params.name || '';
                    }
                },
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: links,
                    categories: [
                        { name: '院系 (Department)' },
                        { name: '教授 (Professor)' },
                        { name: '机构 (Institute)' },
                        { name: '研究组 (Research Group)' }
                    ],
                    roam: true,
                    zoom: 0.6,
                    label: { position: 'right' },
                    lineStyle: { curveness: 0.2 },
                    // 物理引擎参数优化：让院系聚中心，机构/研究组散外圈
                    force: {
                        repulsion: 800,        // 增大斥力，防止挤在一起
                        gravity: 0.03,         // 降低重力，减少向中心聚集
                        edgeLength: [80, 250], // 扩大边长范围，允许更远距离
                        friction: 0.4,         // 降低摩擦力，加速布局收敛
                        layoutAnimation: true,
                        preventOverlap: true
                    }
                }]
            };

            // 使用 merge: false 强制重绘，避免节点残留
            myChart.setOption(option, { notMerge: true }); 
        }

        // --- 点击交互 (Drawer) ---
// --- 点击交互 (Drawer) ---
        myChart.on('click', function(params) {
            if (params.dataType !== 'node') return;
            const data = params.data;

            function getTitleHtml(name, fallbackUrl = null) {
            // 1. 优先查找 orgUrls (适用于 Department, Institutes)
            let url = orgUrls[name];
            
            // 2. 如果 orgUrls 没有，且传入了 fallbackUrl (适用于 Professor)
            if (!url && fallbackUrl) {
                url = fallbackUrl;
            }

            // 3. 如果找到了 URL，返回 <a> 标签；否则返回纯文本
            if (url) {
                return `<a href="${url}" target="_blank" title="Open Link">${name}<span class="link-icon">↗</span></a>`;
            } else {
                return name;
            }
        }

            // 情况 A: 点击的是 机构(inst)、研究组(group) 或 院系(dept) -> 显示成员列表
            if (['inst', 'group', 'dept'].includes(data.nodeType)) {
                
                $('#drawerTitle').html(getTitleHtml(data.name));
                let members = [];

                // 筛选逻辑
                if (data.nodeType === 'dept') {
                    members = globalRawData.filter(p => p.dept === data.name);
                } else if (data.nodeType === 'inst') {
                    members = globalRawData.filter(p => p.inst && p.inst.includes(data.name));
                } else if (data.nodeType === 'group') {
                    members = globalRawData.filter(p => 
                        p.research_group && p.research_group.some(g => {
                            // 忽略 CE 的 Neuro-Engineering
                            if (g.group_name === "Neuro-Engineering" && g.group_dept === "CE") {
                                return false;
                            }
                            return g.group_name === data.name;
                        })
                    );
                }

                // 生成成员列表 HTML
                let html = members.length ? '' : '<p style="color:#999">No data found.</p>';
                members.forEach(m => {
                    const ds = deptStyle[m.dept];
                    // 防御性编程：防止数据里有未知院系导致报错
                    const safeDs = ds || { color: '#ccc', labelColor: '#000', border: '#ccc' };
                    const tagStyle = `background:${safeDs.color}; color:${safeDs.labelColor}; border:1px solid ${safeDs.border}`;
                    html += `
                        <div class="prof-list-item">
                            <a href="${m.website}" target="_blank" class="prof-link">${m.name}</a>
                            <div class="tag-row">
                                <span class="mini-tag" style="${tagStyle}">${m.dept}</span>
                            </div>
                        </div>`;
                });
                $('#drawerList').html(html);
                $('#infoDrawer').addClass('open');
            } 
            
            // // <--- 修改处 3: 点击教授节点 -> 不再直接跳转，而是打开 Drawer 显示详情
            else if (data.nodeType === 'prof') {
                // 1. 在原始数据中找到该教授的完整信息
                const p = globalRawData.find(item => item.name === data.name);
                if (!p) return;

                // 2. 设置标题
                $('#drawerTitle').html(getTitleHtml(p.name, p.website));

                // 3. 构建详情 HTML
                let html = '';

                // A. 访问网站按钮

                // B. 所属院系 (Department)
                const dStyle = deptStyle[p.dept] || { color: '#eee', labelColor: '#333', border: '#ccc' };
                const badgeStyle = `background:${dStyle.color}; color:${dStyle.labelColor}; border:1px solid ${dStyle.border}; padding:2px 8px; border-radius:4px; font-weight:bold; font-size:12px;`;
                
                html += `
                    <div class="detail-section">
                        <strong>DEPARTMENT</strong>
                        <span style="${badgeStyle}">${p.dept}</span>
                    </div>`;

                // C. 所属机构 (Institutes)
                if (p.inst && p.inst.length > 0) {
                    html += `<div class="detail-section"><strong>INSTITUTES</strong><ul class="detail-list">`;
                    p.inst.forEach(i => html += `<li>${i}</li>`);
                    html += `</ul></div>`;
                }

                // D. 所属研究组 (Research Groups)
                if (p.research_group && p.research_group.length > 0) {
                    // 先过滤掉 CE 的 Neuro-Engineering
                    const filteredGroups = p.research_group.filter(g => 
                        !(g.group_name === "Neuro-Engineering" && g.group_dept === "CE")
                    );
                    
                    if (filteredGroups.length > 0) {
                        html += `<div class="detail-section"><strong>RESEARCH GROUPS</strong><ul class="detail-list">`;
                        filteredGroups.forEach(g => {
                            // 获取研究组所属院系的颜色
                            const gDs = deptStyle[g.group_dept] || { color: '#f0f0f0', labelColor: '#666', border: '#ddd' };
                            const gBadgeStyle = `background:${gDs.color}; color:${gDs.labelColor}; border:1px solid ${gDs.border}; font-size:10px; padding:1px 5px; border-radius:3px; margin-left:6px; vertical-align:middle;`;
                            
                            // 显示格式: 组名 + [院系小标签]
                            html += `<li><span style="${gBadgeStyle}">${g.group_dept}</span> ${g.group_name}</li>`;
                        });
                        html += `</ul></div>`;
                    }
                }

                // 4. 填充内容并打开
                $('#drawerList').html(html);
                $('#infoDrawer').addClass('open');
            }
        });
        
        // 点击空白关闭 Drawer
        myChart.getZr().on('click', function(e) { if (!e.target) closeDrawer(); });
        window.onresize = function() { myChart.resize(); };
</script>
</body>
</html>