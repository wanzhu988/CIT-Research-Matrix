<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CIT Professor Network</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #f9f9f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #main { width: 100%; height: 100vh; }
        
        /* --- å·¦ä¸Šè§’æ§åˆ¶é¢æ¿ --- */
        .control-panel {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #eee;
            max-width: 260px;
        }
        .control-panel h3 { margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #333; }
        .hint { font-size: 12px; color: #666; line-height: 1.5; }

        /* --- ä¾§è¾¹æŠ½å±‰ (Drawer) æ ·å¼ --- */
        .drawer {
            position: fixed; 
            top: 0; 
            right: -400px; /* é»˜è®¤éšè—åœ¨å±å¹•å³ä¾§å¤–éƒ¨ */
            width: 350px; 
            height: 100%; 
            background-color: #fff;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); /* å·¦ä¾§é˜´å½± */
            z-index: 999; /* ä¿è¯åœ¨å›¾è¡¨ä¹‹ä¸Š */
            transition: right 0.3s ease-in-out; /* æ»‘åŠ¨åŠ¨ç”» */
            display: flex;
            flex-direction: column;
        }
        
        .drawer.open {
            right: 0; /* æ»‘å…¥å±å¹• */
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #fff;
            display: flex; justify-content: space-between; align-items: center;
        }
        .drawer-header h2 { margin: 0; font-size: 18px; color: #333; }
        .close-btn { 
            cursor: pointer; font-size: 24px; color: #999; line-height: 1; 
            transition: color 0.2s;
        }
        .close-btn:hover { color: #333; }

        .drawer-body {
            flex: 1; /* å æ®å‰©ä½™é«˜åº¦ */
            padding: 20px;
            overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶æ»šåŠ¨ */
        }

        /* åˆ—è¡¨é¡¹æ ·å¼ */
        .prof-list-item {
            padding: 12px 0; border-bottom: 1px solid #f5f5f5;
            display: flex; justify-content: space-between; align-items: center;
        }
        .prof-link { text-decoration: none; color: #333; font-weight: 500; font-size: 14px; }
        .prof-link:hover { color: #007bff; }
        .dept-badge { 
            padding: 2px 8px; border-radius: 12px; font-size: 11px; 
            font-weight: bold; border: 1px solid transparent;
        }
        .inst-link-btn {
            display: block; margin-bottom: 15px; text-decoration: none;
            color: #007bff; font-size: 13px; font-weight: 600;
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <h3>CIT Network</h3>
        <div class="hint">
            <p>ğŸ¨ <b>Colors:</b> Identify Departments.</p>
            <p>ğŸ–±ï¸ <b>Click Nodes:</b>
                <br>â€¢ <b>Dept/Institute:</b> Open list (Right Drawer).
                <br>â€¢ <b>Professor:</b> Visit website.
            </p>
        </div>
    </div>

    <div id="infoDrawer" class="drawer">
        <div class="drawer-header">
            <h2 id="drawerTitle">Title</h2>
            <span class="close-btn" onclick="closeDrawer()">&times;</span>
        </div>
        <div class="drawer-body">
            <a id="drawerLink" href="#" target="_blank" class="inst-link-btn">ğŸ”— Visit Website</a>
            <div id="drawerList"></div>
        </div>
    </div>
    
    <div id="main"></div>

<script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);
        var option;

        // --- 1. é¢œè‰²é…ç½® (å°½é‡è¿˜åŸ Google Sheets æˆªå›¾) ---
        // CS: æµ…ç°åº•é»‘å­—, CE: æµ…ç»¿åº•ç»¿å­—, EE: æ·±æ£•åº•ç™½å­—, MATH: æµ…çº¢åº•çº¢å­—
        const deptStyle = {
            "CS":   { color: "#eaecf0", labelColor: "#333333", border: "#d0d7de" },
            "CE":   { color: "#d1e8d6", labelColor: "#137333", border: "#a8dab5" },
            "EE":   { color: "#795548", labelColor: "#ffffff", border: "#5d4037" }, 
            "MATH": { color: "#ffcdd2", labelColor: "#b71c1c", border: "#ef9a9a" }
        };
        const instColor = "#fcca00"; 

        var orgUrls = {
            "CS": "https://www.cs.cit.tum.de/",
            "MATH": "https://www.math.cit.tum.de/",
            "CE": "https://www.ce.cit.tum.de/",
            "EE": "https://www.ee.cit.tum.de/",
            "MDSI": "https://www.mdsi.tum.de/",
            "MIRMI": "https://www.mirmi.tum.de/",
            "MCML": "https://mcml.ai/",
            "MUDS": "https://www.mu-ds.de/",
            "MIBE": "https://www.bioengineering.tum.de/"
        };

        // æŠ½å±‰æ§åˆ¶å‡½æ•°
        function openDrawer() { document.getElementById('infoDrawer').classList.add('open'); }
        function closeDrawer() { document.getElementById('infoDrawer').classList.remove('open'); }

        myChart.showLoading();

        $.getJSON('data.json', function (rawData) {
            myChart.hideLoading();

            var nodes = [];
            var links = [];
            var existMap = {}; 

            function addNode(name, type, deptKey) {
                if (existMap[name]) return;
                
                let node = {
                    name: name,
                    nodeType: type,
                    dept: deptKey,
                    draggable: true
                };

                if (type === 'dept') {
                    // --- ä¿®æ”¹ï¼šé™¢ç³»èŠ‚ç‚¹æ ·å¼ ---
                    const style = deptStyle[name] || { color: '#ccc', labelColor: '#000' };
                    node.symbolSize = 70; // å¤§åœ†
                    node.itemStyle = { 
                        color: style.color, 
                        borderColor: style.border, borderWidth: 2,
                        opacity: 1
                    };
                    // Label é…ç½®ï¼šå±…ä¸­ (inside)
                    node.label = { 
                        show: true, 
                        position: 'inside', // <--- å…³é”®ä¿®æ”¹ï¼šæ–‡å­—åœ¨åœ†å†…
                        fontSize: 14, 
                        fontWeight: 'bold', 
                        color: style.labelColor 
                    };
                    node.clickUrl = orgUrls[name];

                } else if (type === 'prof') {
                    const style = deptStyle[deptKey] || { color: '#5470c6' };
                    node.symbolSize = 18;
                    node.itemStyle = { color: style.color, borderColor: style.border, borderWidth: 1 };
                    node.label = { 
                        show: true, position: 'right', color: '#666', fontSize: 12,
                        formatter: function(p) { return p.data.name.split(' ').pop(); }
                    }; 
                    let profData = rawData.find(p => p.name === name);
                    node.clickUrl = profData ? profData.website : "";

                } else if (type === 'inst') {
                    node.symbolSize = 45;
                    node.itemStyle = { color: instColor, borderColor: '#f57f17', borderWidth: 2 };
                    node.label = { show: true, fontSize: 11, fontWeight: 'bold', color: '#333' };
                    node.clickUrl = orgUrls[name];
                }

                nodes.push(node);
                existMap[name] = true;
            }

            // æ„å»ºæ•°æ®
            rawData.forEach(function (prof) {
                addNode(prof.name, 'prof', prof.dept);
                if (prof.dept) {
                    addNode(prof.dept, 'dept', prof.dept);
                    links.push({ source: prof.name, target: prof.dept, lineStyle: { color: '#ccc', width: 2, opacity: 0.5 } });
                }
                if (prof.inst) {
                    prof.inst.forEach(function (instName) {
                        addNode(instName, 'inst', null);
                        links.push({ source: prof.name, target: instName, lineStyle: { color: '#fcca00', type: 'dashed', width: 1 } });
                    });
                }
            });

            option = {
                title: { text: '' },
                tooltip: { trigger: 'item', padding: 10, backgroundColor: 'rgba(255,255,255,0.9)', textStyle: {color:'#333'} },
                series: [
                    {
                        type: 'graph',
                        layout: 'force',
                        data: nodes,
                        links: links,
                        roam: true,
                        zoom: 0.85, // ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œç»™å³ä¾§ä¾§è¾¹æ ç•™ç‚¹è§†è§‰ç©ºé—´
                        label: { position: 'right' },
                        force: {
                            repulsion: 350,
                            gravity: 0.1,
                            edgeLength: [40, 160],
                            layoutAnimation: true
                        },
                        emphasis: { focus: 'adjacency', lineStyle: { width: 4 } }
                    }
                ]
            };

            myChart.setOption(option);

            // --- æ ¸å¿ƒäº¤äº’é€»è¾‘ ---
            myChart.on('click', function(params) {
                if (params.dataType !== 'node') return;
                const nodeData = params.data;

                // é€»è¾‘ï¼šå¦‚æœç‚¹å‡»çš„æ˜¯ "Institute" æˆ–è€… "Department" -> æ‰“å¼€ä¾§è¾¹æ 
                if (nodeData.nodeType === 'inst' || nodeData.nodeType === 'dept') {
                    
                    const targetName = nodeData.name;
                    const isDept = nodeData.nodeType === 'dept';

                    // 1. è®¾ç½®æ ‡é¢˜å’Œé“¾æ¥
                    $('#drawerTitle').text(targetName + (isDept ? " Department" : " Institute"));
                    $('#drawerLink').attr('href', nodeData.clickUrl).text("ğŸ”— Visit " + targetName + " Website");

                    // 2. ç­›é€‰æˆå‘˜ (é™¢ç³» vs æœºæ„ ç­›é€‰é€»è¾‘ä¸åŒ)
                    let members = [];
                    if (isDept) {
                        // å¦‚æœç‚¹çš„æ˜¯é™¢ç³»ï¼Œæ‰¾æ‰€æœ‰ dept å­—æ®µç­‰äºè¯¥åå­—çš„æ•™æˆ
                        members = rawData.filter(p => p.dept === targetName);
                    } else {
                        // å¦‚æœç‚¹çš„æ˜¯æœºæ„ï¼Œæ‰¾ inst æ•°ç»„åŒ…å«è¯¥åå­—çš„æ•™æˆ
                        members = rawData.filter(p => p.inst && p.inst.includes(targetName));
                    }
                    
                    // 3. ç”Ÿæˆåˆ—è¡¨ HTML
                    let htmlContent = members.length ? '' : '<p style="color:#999">No members found.</p>';
                    members.forEach(m => {
                        let dStyle = deptStyle[m.dept] || { color: '#ccc', labelColor: '#000', border: '#999' };
                        // ä½¿ç”¨ä½ è¦æ±‚çš„æ ‡ç­¾æ ·å¼
                        let badgeStyle = `background-color:${dStyle.color}; color:${dStyle.labelColor}; border:1px solid ${dStyle.border}`;
                        
                        htmlContent += `
                            <div class="prof-list-item">
                                <a href="${m.website}" target="_blank" class="prof-link">${m.name}</a>
                                <span class="dept-badge" style="${badgeStyle}">${m.dept}</span>
                            </div>
                        `;
                    });
                    
                    $('#drawerList').html(htmlContent);

                    // 4. æ‰“å¼€ä¾§è¾¹æ  (æ— é®ç½©)
                    openDrawer();
                } 
                // å¦‚æœç‚¹çš„æ˜¯æ•™æˆ -> ç›´æ¥è·³è½¬
                else if (nodeData.clickUrl) {
                    window.open(nodeData.clickUrl, '_blank');
                }
            });

            // ç‚¹å‡»ç”»å¸ƒç©ºç™½å¤„å…³é—­ä¾§è¾¹æ  (å¯é€‰ä¼˜åŒ–)
            myChart.getZr().on('click', function(params) {
                if (!params.target) {
                    closeDrawer();
                }
            });

        }).fail(function() {
            alert("Error: Could not load data.json.");
        });

        window.onresize = function() { myChart.resize(); };
    </script>
</body>
</html>